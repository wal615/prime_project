---
title: "Reproduce_proposal_result_rep_beta"
author: "Xuelong Wang"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_caption: yes
    fig_width: 18
    theme: united
    toc: true
    number_sections: true
---

```{r, include=FALSE}
knitr::opts_knit$set(root.dir = "~/dev/projects/Chen_environmental_study/")
source("./R_code/Yang_REML.R")
options(width = 100)
library(ggplot2)
library(tidyverse)
library(sas7bdat)
library(printr)

load("./result/simulation_result_reproduce_with_rep_beta")

#####################################################################################
## figures number function
#####################################################################################
# A function for captioning and referencing images
fig <- local({
    i <- 0
    ref <- list()
    list(
        cap=function(refName, text) {
            i <<- i + 1
            ref[[refName]] <<- i
            paste("Figure ", i, ": ", text, sep="")
        },
        ref=function(refName) {
            ref[[refName]]
        })
})

#####################################################################################
## figures number function
#####################################################################################
# A function for captioning and referencing tables

tab <- local({
    i <- 0
    ref <- list()
    list(
        cap=function(refName, text) {
            i <<- i + 1
            ref[[refName]] <<- i
            paste("Table ", i, ": ", text, sep="")
        },
        ref=function(refName) {
            ref[[refName]]
        })
})

#####################################################################################
## calculate MSE for the result 
#####################################################################################
sum_fn <- function(x) {
  x <- x[x[,1]!=0,]
  c(colMeans((x[,c(3,4)] -x[,c(1,2)])^2), colMeans((x[,c(5,6)] -x[,c(1,2)])^2))}

#####################################################################################
## plot function
#####################################################################################
plot_fn <- function(x, names) {
    x <- x[x[,1]!=0,]
    g1<- ggplot(tidyr::gather(data.frame(x[,c(1,3,5)])), aes(value, fill = key, y = ..density..)) +
    geom_histogram(alpha = 0.2, position = "identity", binwidth =  0.5) +
    geom_density(alpha = 0.2) +
    xlim(-30,50)+
    labs(fill="Methods")+
    ggtitle(paste0("main_total_effect_",names))
  
    g2 <- ggplot(tidyr::gather(data.frame(x[,c(2,4,6)])), aes(value, fill = key, y = ..density..)) +
    geom_histogram(alpha = 0.2, position = "identity", binwidth =  0.5) +
    geom_density(alpha = 0.2) +
    xlim(0,40)+
    labs(fill="Methods")+
    ggtitle(paste0("interaction_total_effect_",names))
    
    gridExtra::grid.arrange(g1, g2, ncol=2)
}

box_plot_fn <- function(x, names){
  x <- x[x[,1]!=0,]
  g1 <- ggplot(tidyr::gather(data.frame(x[,c(1,3,5)])), aes(x = key, y = value, color = key)) + 
    geom_boxplot() +
    ylim(-30,50)+
    labs(color ="Methods")+
    labs(x = "method", y = "Variance")+
    ggtitle(paste0("main_total_effect_",names))
  
  g2 <- ggplot(tidyr::gather(data.frame(x[,c(2,4,6)])), aes(x = key, y = value, color = key)) + 
    geom_boxplot() +
    ylim(0, 40)+
    labs(color ="Methods")+
    labs(x = "method", y = "Variance")+
    ggtitle(paste0("interaction_total_effect_",names))
    
  gridExtra::grid.arrange(g1, g2, ncol=2)
}
```

# Reproduce the proposal result with different beta's values

## PCB with no intercation and no intercation term in the fitting model 

```{r, echo=FALSE}
out_table <- t(sum_fn(result_list$PCB_no_inter_m))
rownames(out_table) <- "MSE"

knitr::kable(x = out_table, 
             row.names = TRUE,
             format = "html",
             caption = tab$cap("PCB_no_inter_m","MSE of estimated varaince with PCB data without intercation"))  %>% 
  kableExtra::kable_styling(full_width = FALSE)
```
- In the Table `r tab$ref('PCB_no_inter_m')`, "GCTA_main" and "GCTA_interaction" stands for the estimation of GCTA method. 
- "pro_main" and "pro_interaction" stand for the estimation of proposed method. 
- MSE is calculated by $\sum(\sigma^2_{estimation} - \sigma^2_{true})^2/n$
- n in our case is 50

```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("PCB_no_inter_m", "Box-plot of Main and Interaction variance with PCB data without intercation")}
  box_plot_fn(result_list$PCB_no_inter_m,"PCB_no_inter_m")
```

```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("PCB_no_inter_m", "Histogram of Main and Interaction variance with cox-box transformed data")}
  plot_fn(result_list$PCB_no_inter_m,"PCB_no_inter_m")
```


## PCB with no intercation but with intercation term in the fitting model 

```{r, echo=FALSE}
out_table <- t(sum_fn(result_list$PCB_no_inter))
rownames(out_table) <- "MSE"

knitr::kable(x = out_table, 
             row.names = TRUE,
             format = "html",
             caption = tab$cap("PCB_no_inter","MSE of estimated varaince with PCB data without intercation"))  %>% 
  kableExtra::kable_styling(full_width = FALSE)
```


```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("PCB_no_inter", "Box-plot of Main and Interaction variance with PCB data without intercation")}
  box_plot_fn(result_list$PCB_no_inter,"PCB_no_inter")
```

```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("PCB_no_inter", "Histogram of Main and Interaction variance with cox-box transformed data")}
  plot_fn(result_list$PCB_no_inter,"PCB_no_inter")
```

## Simulated covariates from uncorrelated normal distribution

```{r, echo=FALSE}
out_table <- t(sum_fn(result_list$b_norm_uncorr))
rownames(out_table) <- "MSE"

knitr::kable(x = out_table, 
             row.names = TRUE,
             format = "html",
             caption = tab$cap("b_norm_uncorr","MSE of estimated varaince with PCB data without intercation"))  %>% 
  kableExtra::kable_styling(full_width = FALSE)
```


```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("b_norm_uncorr", "Box-plot of Main and Interaction variance with PCB data without intercation")}
  box_plot_fn(result_list$b_norm_uncorr,"b_norm_uncorr")
```

```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("b_norm_uncorr", "Histogram of Main and Interaction variance with cox-box transformed data")}
  plot_fn(result_list$b_norm_uncorr,"b_norm_uncorr")
```

## Simulated covariates from uncorrelated normal distribution

```{r, echo=FALSE}
out_table <- t(sum_fn(result_list$b_norm_uncorr))
rownames(out_table) <- "MSE"

knitr::kable(x = out_table, 
             row.names = TRUE,
             format = "html",
             caption = tab$cap("b_norm_uncorr","MSE of estimated varaince with PCB data without intercation"))  %>% 
  kableExtra::kable_styling(full_width = FALSE)
```


```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("b_norm_uncorr", "Box-plot of Main and Interaction variance with PCB data without intercation")}
  box_plot_fn(result_list$b_norm_uncorr,"b_norm_uncorr")
```

```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("b_norm_uncorr", "Histogram of Main and Interaction variance with cox-box transformed data")}
  plot_fn(result_list$b_norm_uncorr,"b_norm_uncorr")
```

## Simulated covariates from correlated normal distribution


```{r, echo=FALSE}
out_table <- t(sum_fn(result_list$b_norm_corr))
rownames(out_table) <- "MSE"

knitr::kable(x = out_table, 
             row.names = TRUE,
             format = "html",
             caption = tab$cap("b_norm_corr","MSE of estimated varaince with PCB data without intercation"))  %>% 
  kableExtra::kable_styling(full_width = FALSE)
```


```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("b_norm_corr", "Box-plot of Main and Interaction variance with PCB data without intercation")}
  box_plot_fn(result_list$b_norm_corr,"b_norm_corr")
```

```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("b_norm_corr", "Histogram of Main and Interaction variance with cox-box transformed data")}
  plot_fn(result_list$b_norm_corr,"b_norm_corr")
```

## PCB data with intercation term 

```{r, echo=FALSE}
out_table <- t(sum_fn(result_list$PCB_with_inter))
rownames(out_table) <- "MSE"

knitr::kable(x = out_table, 
             row.names = TRUE,
             format = "html",
             caption = tab$cap("PCB_with_inter","MSE of estimated varaince with PCB data without intercation"))  %>% 
  kableExtra::kable_styling(full_width = FALSE)
```


```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("PCB_with_inter", "Box-plot of Main and Interaction variance with PCB data without intercation")}
  box_plot_fn(result_list$PCB_with_inter,"PCB_with_inter")
```

```{r , echo = FALSE, warning=FALSE, fig.cap=fig$cap("PCB_with_inter", "Histogram of Main and Interaction variance with cox-box transformed data")}
  plot_fn(result_list$PCB_with_inter,"PCB_with_inter")
```