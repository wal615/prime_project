---
title: "Transformation_simulation"
author: "Xuelong Wang"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_width: 15
    theme: readable
---

```{r, include=FALSE}
knitr::opts_knit$set(root.dir = "~/dev/projects/Chen_environmental_study/")
source("./R_code/Yang_REML.R")
options(width = 100)
library(ggplot2)
library(tidyverse)
library(sas7bdat)

#####################################################################################
## calculate MSE for the result 
#####################################################################################
sum_fn <- function(x) {
  x <- x[x[,1]!=0,]
  c(colMeans((x[,c(3,4)] -x[,c(1,2)])^2), colMeans((x[,c(5,6)] -x[,c(1,2)])^2))}
#####################################################################################

#####################################################################################
## plot function
#####################################################################################
plot_fn <- function(x, names) {
    x <- x[x[,1]!=0,]
    g1<- ggplot(tidyr::gather(data.frame(x[,c(1,3,5)])), aes(value, fill = key, y = ..density..)) +
    geom_histogram(alpha = 0.2, position = "identity", binwidth =  0.1) +
    geom_density(alpha = 0.2) +
    ggtitle(paste0("main_total_effect_",names))
  
    g2 <- ggplot(tidyr::gather(data.frame(x[,c(2,4,6)])), aes(value, fill = key, y = ..density..)) +
    geom_histogram(alpha = 0.2, position = "identity", binwidth =  0.1) +
    geom_density(alpha = 0.2) +
    ggtitle(paste0("interaction_total_effect_",names))
    gridExtra::grid.arrange(g1, g2, ncol=2)
}
```
# Transformation


- Based the density and histogram plots, the covariates' distributions are left skewed (heavy tail)
- I have tried 3 different transformation methods `log`, `square root` and `box-cox`
- Transformation is made __BEFORE__ the simulation of main and interaction signals
- Before applying the transformation methods to PCB data, Standardization step was modified to deal with real value instead of __Rank__. Because any monotone transformation will not have any difference on the result if we use rank. 

# Simulation Result
- The following tables are about the MSE of estimated variance
- Histogram plots are about the distribution of the true variances, GCTA estimated variances and Proposed methods'

```{r, echo=FALSE}
load("./result/simulation_log_sqrt_tranformation")

for (j in 1:length(result_list)){
  cat(names(result_list)[j],"\n")
  
  print(sum_fn(result_list[[j]]))
  
  plot_fn(result_list[[j]],names(result_list)[j])
}

# lapply(FUN = sum_fn, X = result_list)
# lapply(X = result_list, plot_fn, )
```

- It seems that after changing the standardization method, the MSE is much larger than when using the rank as the covariates values, especially for the interaction total effect estimation  
- one possible reason is that during each simulation iteration, the interaction signals are much larger than using ranks as the covariates  
- The `log` and `box-cox` transformation methods could reduce the method MSE


<!-- # Histgram of covariates -->

<!-- ## Original scale -->
<!-- ```{r, echo=FALSE} -->
<!-- a=read.sas7bdat("~/dev/projects/Chen_environmental_study/R_code/pcbs1000nomiss.sas7bdat") -->
<!-- b=data.matrix(a[,2:35], rownames.force = NA) -->
<!-- for(i in (1:5)*3){ -->
<!--   (ggplot(data.frame(covariate = b[,i])) + -->
<!--   geom_histogram(aes(x=covariate, y = ..density.. ), alpha = 0.2, binwidth = 0.02, position="identity") + -->
<!--   geom_density(aes(x=covariate, y=..density..),alpha = 0.2)+ -->
<!--   labs(x = colnames(b)[i])) %>% print() -->

<!-- } -->
<!-- ``` -->

<!-- ## log transformation -->

<!-- ```{r, echo=FALSE} -->
<!-- b_log <- log(b) -->
<!-- for(i in (1:5)*3){ -->
<!--   ggplot(data.frame(covariate = b_log[,i])) + -->
<!--   geom_histogram(aes(x=covariate, y = ..density.. ), alpha = 0.2, binwidth = 0.02, position="identity") + -->
<!--   geom_density(aes(x=covariate,y=..density..),alpha = 0.2)+ -->
<!--   labs(x = colnames(b_log)[i]) -->

<!-- } -->
<!-- ``` -->

<!-- ## square root transformation -->

<!-- ```{r, echo=FALSE} -->
<!-- b_sqrt <- sqrt(b) -->
<!-- for(i in (1:5)*3){ -->
<!--   (ggplot(data.frame(covariate = b_sqrt[,i])) + -->
<!--   geom_histogram(aes(x=covariate, y = ..density.. ), alpha = 0.2, binwidth = 0.02, position="identity") + -->
<!--   geom_density(aes(x=covariate,y=..density..),alpha = 0.2)+ -->
<!--   labs(x = colnames(b_sqrt)[i])) %>% print() -->

<!-- } -->
<!-- ``` -->
<!-- ## box-cox transformation -->

<!-- ```{r, echo=FALSE} -->
<!-- b_cox <- apply(X = b, MARGIN = 2, FUN = box_cox_tran) -->
<!-- for(i in (1:5)*3){ -->
<!--   (ggplot(data.frame(covariate = b_cox[,i])) + -->
<!--   geom_histogram(aes(x=covariate, y = ..density.. ), alpha = 0.2, binwidth = 0.02, position="identity") + -->
<!--   geom_density(aes(x=covariate,y=..density..))+ -->
<!--   labs(x = colnames(b_cox)[i])) %>% print() -->
<!-- } -->
<!-- ``` -->

