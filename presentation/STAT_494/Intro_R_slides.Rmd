---
title: 'Introduction to R and Statlab Server'
short-title: "STAT 494/451"
author: "Xuelong Wang"
date: '`r format(Sys.Date(), "%B %d, %Y")`'      # Month DD, YYYY (Main Slide)
short-date: '`r format(Sys.Date(), "%m/%d/%Y")`' # MM/DD/YYYY (Lower Right)
section-titles: false                            # Provides slide headings
safe-columns: true   # Enables special latex macros for columns.
header-includes:
   - \usepackage{amsmath, bbm}
output: 
   uiucthemes::beamer_illinois: 
       toc: true
       fig_height: 6
---

```{r setup, include=FALSE}
options(width = 40)
library(doParallel)
library(foreach)
library(parallel)
library(iterators)
```

# Introduction to the Statlab Server

### How to connect to the Statlab Server

* Fixed IP address 131.193.178.77
* hostname: statlab.math.uic.edu 
* Mac users 
    + Terminal.app
    + ssh username@statlab.math.uic.edu
* Windows users 
    + PuTTY
    + open source SSH client for windows
    + http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html
    
### How to use the R.Studio 

* R 
    + Using Terminal or PuTTY 
    + just type R
* Rstudio 
    + Web browser e.g. Chrome 
    + http://statlab.math.uic.edu:8787/
* some notes about using Rstudio 
    + save all the documents 
    + save and delete all objects in the Global Enviroment (rm(list=ls()))
    + using top and kill the terminate your R sessions


# Introduction to parallel computation 

### *foreach* package

#### An easy and starndard way of parallel comuptation

- Can run a for-loop task as a set of of parallel tasks 

- Take care of the communication between the tasks (cores)

### Getting start Example

Calculate the sum of the square $$\sum_{i=1}^{10000}\sum_{j=1}^{i} j^2$$
  There is a warning saying the loop ran sequentially   
To run the loop parallelly,  we need to register parallel backends. 

```{r, tidy = TRUE, fill =TRUE, collapse=TRUE, tidy.opts=list(width.cutoff = 50)}
system.time(foreach(i=1:10000) %do% sum((1:i)^2))[3]
system.time(foreach(i=1:10000) %dopar% sum((1:i)^2))[3]
```

### Parallel backends

```{r, tidy = TRUE, fill =TRUE, collapse=TRUE}
registerDoParallel(cores = 2)
getDoParWorkers()
```

*registerDoParallel()* is used to register cores to parallel computation 

```{r, tidy = TRUE, fill =TRUE, collapse=TRUE, tidy.opts=list(width.cutoff = 50)}
system.time(foreach(i=1:10000) %do% sum(sqrt(1:i)))[3]
system.time(foreach(i=1:10000) %dopar% sum(sqrt(1:i)))[3]
```

### Bootstraping example
```{r, echo=FALSE, eval=TRUE}
x <- iris[which(iris[,5] != "setosa"), c(1,5)]
dopar <- system.time(r <- foreach(i = 1:10000) %dopar% {
  ind <- sample(100, 100, replace=TRUE)
  result1 <- glm(x[ind,2]~x[ind,1],
                 family=binomial(logit))
  coefficients(result1)
})[3]
do <- system.time(r <- foreach(i = 1:10000) %do% {
  ind <- sample(100, 100, replace=TRUE)
  result1 <- glm(x[ind,2]~x[ind,1],
                 family=binomial(logit))
  coefficients(result1)
})[3]
```

```{r, tidy = TRUE, fill =TRUE, collapse=TRUE, tidy.opts=list(width.cutoff = 45)}
dim(x)
r <- foreach(i = 1:10000) %dopar% {
  ind <- sample(100, 100, replace=TRUE)
  result1 <- glm(x[ind,2]~x[ind,1], family=binomial(logit))
  coefficients(result1)
}
```
- Escaped time for using  `r getDoParWorkers()` cores is `r dopar` seconds
- Escaped time for using single core is `r do` seconds


# data.table

### data.table

#### Why data.table

- Data.table is an extension of data.frame package in R
- Much Faster than other structures in R
- SQL type syntax: `DT[where, select|update|do, by]`

### How to create a data.table

#### `data.table` function
```{r, tidy = TRUE, fill =TRUE, collapse=TRUE, tidy.opts=list(width.cutoff = 40)}
library(data.table)
DT = data.table(x=c("b","b","b","a","a"),
                v=rnorm(5))
CARS = data.table(cars)
tables()
```

### How to create a data.table
#### Subset
```{r, tidy = TRUE, fill =TRUE, collapse=TRUE, tidy.opts=list(width.cutoff = 30)}
library(data.table)
DT[2,]
DT[x=="a",]
cat(try(DT["a",],silent=TRUE))
```

### How to create a data.table
#### setKeys
```{r, tidy = TRUE, fill =TRUE, collapse=TRUE, tidy.opts=list(width.cutoff = 40)}
setkey(DT,x)
DT["a",]
```

- Note that the keys are not requried to be unique.

### How fast 

#### data.frame 
```{r, tidy = TRUE, fill =TRUE, collapse=TRUE, tidy.opts=list(width.cutoff = 40)}
grpsize = ceiling(1e7/26^2) # 10 million rows, 676 groups
DF <- data.frame(x=rep(LETTERS,each=26*grpsize),
                 y=rep(letters,each=grpsize),
                 v=runif(grpsize*26^2),
                 stringsAsFactors=FALSE)
head(DF,3)
dim(DF)
```

### How fast 

#### data.frame 
```{r, tidy = TRUE, fill =TRUE, collapse=TRUE, tidy.opts=list(width.cutoff = 40)}
tt=system.time(ans1 <- DF[DF$x=="R" & DF$y=="h",]) # ’vector scan’
tt
head(ans1,3)
```

### How fast 

#### data.frame 
```{r, tidy = TRUE, fill =TRUE, collapse=TRUE, tidy.opts=list(width.cutoff = 40)}
DT = as.data.table(DF)
system.time(setkey(DT,x,y))
ss=system.time(ans2 <- DT[list("R","h")])
ss
head(ans2,3)
```